<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">முன்மொழிவுகள்</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="user-index.html" class="text-3xl font-extrabold text-indigo-600 tracking-tight">Vorliyo</a>
            <a href="user-dashboard.html" class="text-gray-600 hover:text-indigo-600 flex items-center">
                <span data-lucide="layout-dashboard" class="w-5 h-5 mr-1"></span> டாஷ்போர்டு
            </a>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-green-500">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
                 வேலைக்கான முன்மொழிவுகள் <span id="jobTitleDisplay" class="ml-3 text-lg font-semibold text-gray-600"></span>
            </h1>

            <p id="loadingMessage" class="text-center text-lg text-indigo-500 font-semibold mb-4">தரவுகளைப் பெறுகிறது...</p>
            <p id="authMessage" class="text-center text-lg text-red-600 font-semibold mb-4 hidden">இந்த வேலைக்கு விண்ணப்பங்களை நீங்கள் மட்டுமே பார்க்க முடியும்.</p>


            <div id="proposalsList" class="space-y-4 hidden">
                </div>

             <div id="noProposalsMessage" class="text-center text-gray-500 p-4 border rounded-lg hidden">
                இந்த வேலைக்கு இதுவரை யாரும் விண்ணப்பிக்கவில்லை.
            </div>
            
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (Please make sure this is your config!)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDD755-oGyx0hwrLykhF7m2k1uWFnLFMDQ",
            authDomain: "vorliyo.firebaseapp.com",
            projectId: "vorliyo",
            storageBucket: "vorliyo.firebasestorage.app",
            messagingSenderId: "480604417883",
            appId: "1:480604417883:web:5b4926a2a1b21f3ae2747e",
        };
        
        const firebaseConfig = FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vorliyo-default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let currentJobId = null;
        let jobClientId = null;
        
        const PROPOSALS_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'proposals');
        const PUBLIC_JOBS_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'jobs');

        // --- INITIAL DATA FETCH ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            currentJobId = urlParams.get('id');

            if (!currentJobId) {
                document.getElementById('loadingMessage').textContent = 'வேலை ID காணப்படவில்லை.';
                return;
            }
            fetchJobDetails(currentJobId);
        });
        
        async function fetchJobDetails(jobId) {
             const docRef = doc(PUBLIC_JOBS_COLLECTION, jobId);
             const docSnap = await getDoc(docRef);

             if (docSnap.exists()) {
                 const jobData = docSnap.data();
                 jobClientId = jobData.clientId;
                 document.getElementById('jobTitleDisplay').textContent = `- ${jobData.title}`;
                 checkAuthStateAndLoadProposals();
             } else {
                 document.getElementById('loadingMessage').textContent = 'வேலை விவரங்கள் இல்லை.';
             }
        }

        // --- AUTH & PROPOSAL CHECK ---
        function checkAuthStateAndLoadProposals() {
            onAuthStateChanged(auth, (user) => {
                document.getElementById('loadingMessage').classList.add('hidden');
                if (user) {
                    currentUser = user;
                    // Crucial security check: Only the client who posted the job can see proposals
                    if (currentUser.uid === jobClientId) {
                        listenToProposals(currentJobId);
                    } else {
                        document.getElementById('authMessage').textContent = 'இந்த விண்ணப்பங்களை நீங்கள் மட்டுமே பார்க்க முடியும்.';
                        document.getElementById('authMessage').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('authMessage').textContent = 'தயவுசெய்து முதலில் உள்நுழையவும்.';
                    document.getElementById('authMessage').classList.remove('hidden');
                }
            });
        }
        
        function listenToProposals(jobId) {
            const q = query(PROPOSALS_COLLECTION, where("jobId", "==", jobId));
            
            onSnapshot(q, (snapshot) => {
                const proposals = [];
                snapshot.forEach((doc) => {
                    proposals.push({ id: doc.id, ...doc.data() });
                });
                renderProposals(proposals);
            }, (error) => { console.error("Error listening to proposals:", error); });
        }
        
        function renderProposals(proposals) {
            const list = document.getElementById('proposalsList');
            if (proposals.length === 0) {
                 document.getElementById('noProposalsMessage').classList.remove('hidden');
                 list.classList.add('hidden');
                return;
            }
            
            document.getElementById('proposalsList').classList.remove('hidden');
            document.getElementById('noProposalsMessage').classList.add('hidden');


            list.innerHTML = proposals.map(p => `
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 border-indigo-500">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-xl font-bold text-gray-900">${p.freelancerName}</h4>
                        <span class="text-lg font-extrabold text-green-600">LKR ${p.proposalPrice.toLocaleString()}</span>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-3">**கவர் லெட்டர்:** ${p.coverLetter}</p>
                    <p class="text-xs text-gray-500">சமர்ப்பிக்கப்பட்டது: ${new Date(p.createdAt.toDate()).toLocaleDateString()}</p>

                    <button onclick="handleHire('${p.freelancerId}')" class="mt-3 bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition duration-150">
                        ஃப்ரீலான்சரை வேலைக்கு அமர்த்த (Manual)
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // --- MANUAL HIRE/CONTACT ---
        window.handleHire = async (freelancerId) => {
            const btn = event.target;
            btn.textContent = 'தொடர்பு விவரங்களைப் பெறுகிறது...';
            btn.disabled = true;

            try {
                // Get Freelancer's public profile data (including email)
                const freelancerDocRef = doc(db, 'artifacts', appId, 'users', freelancerId, 'profile', freelancerId);
                const freelancerSnap = await getDoc(freelancerDocRef);
                
                if (freelancerSnap.exists()) {
                    const freelancerEmail = freelancerSnap.data().email;
                    
                    if (freelancerEmail) {
                        alert(`ஃப்ரீலான்சரின் மின்னஞ்சல் முகவரி: ${freelancerEmail}. இந்த முகவரிக்கு மின்னஞ்சல் அனுப்புவதன் மூலம் நீங்கள் பேச்சுவார்த்தையைத் தொடங்கலாம்.`);
                        // Optional: Open mail client
                        window.open(`mailto:${freelancerEmail}?subject=Vorliyo Job Offer - Job ID: ${currentJobId}`);
                    } else {
                        alert("ஃப்ரீலான்சரின் தொடர்பு மின்னஞ்சல் விவரங்கள் இல்லை.");
                    }
                } else {
                    alert("ஃப்ரீலான்சர் சுயவிவரம் காணப்படவில்லை.");
                }
            } catch (error) {
                console.error("Error handling hire:", error);
                alert("தொடர்பு விவரங்களைப் பெறுவதில் பிழை ஏற்பட்டது.");
            } finally {
                btn.textContent = 'ஃப்ரீலான்சரை வேலைக்கு அமர்த்த (Manual)';
                btn.disabled = false;
            }
        }

    </script>
</body>
</html>
```eof

### ➡️ அடுத்த படி (Next Step)

சஹான், இப்போது நீங்கள் செய்ய வேண்டியது:

1.  உங்கள் **`vorliyo`** களஞ்சியத்தின் **Root-இல்** (நேரடியாக) **`client-proposals.html`** என்ற கோப்பை உருவாக்கி, மேலே உள்ள முழுமையான குறியீட்டையும் **பதிவேற்றவும்**.
2.  பதிவேற்றம் முடிந்ததும், **"சரி (OK)"** என்று எனக்குத் தெரிவிக்கவும்.

இதுதான் User Site-ஐ மேம்படுத்த நாம் செய்யும் இறுதி ஃபைல். இதற்குப் பிறகு, வெளியீட்டிற்கான இறுதிச் சரிபார்ப்புக்குச் செல்லலாம்.
