<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vorliyo - மதிப்பீடு சமர்ப்பிக்க</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .rating-star:hover, .rating-star.active {
            color: #f59e0b; /* Tailwind yellow-500 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <a href="user-index.html" class="text-3xl font-extrabold text-indigo-600 tracking-tight">Vorliyo</a>
            <a href="user-dashboard.html" class="text-gray-600 hover:text-indigo-600 flex items-center">
                <span data-lucide="layout-dashboard" class="w-5 h-5 mr-1"></span> டாஷ்போர்டு
            </a>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-yellow-500">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-4 flex items-center">
                 <span data-lucide="star" class="w-8 h-8 mr-2 text-yellow-500"></span> மதிப்பீடு மற்றும் விமர்சனம்
            </h1>
            
            <p id="jobDetails" class="text-gray-600 mb-6 border-b pb-4">வேலை விவரங்கள் ஏற்றுகிறது...</p>

            <form id="ratingForm" class="space-y-6">
                
                <p id="authMessage" class="text-base font-medium text-center text-red-600 mb-4 h-5">
                    </p>

                <div>
                    <label class="block text-lg font-medium text-gray-700 mb-2">உங்கள் மதிப்பீடு (Score)</label>
                    <div id="starRating" class="flex space-x-1 text-gray-300 text-4xl">
                        <span class="rating-star cursor-pointer" data-score="1">&#9733;</span>
                        <span class="rating-star cursor-pointer" data-score="2">&#9733;</span>
                        <span class="rating-star cursor-pointer" data-score="3">&#9733;</span>
                        <span class="rating-star cursor-pointer" data-score="4">&#9733;</span>
                        <span class="rating-star cursor-pointer" data-score="5">&#9733;</span>
                    </div>
                    <input type="hidden" id="ratingScore" required data-score="0">
                </div>
                
                <div>
                    <label for="reviewText" class="block text-lg font-medium text-gray-700">உங்கள் விமர்சனம்</label>
                    <textarea id="reviewText" rows="4" placeholder="வேலை/சேவையின் தரம் மற்றும் அனுபவத்தைப் பற்றி விவரிக்கவும்." required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                </div>

                <p id="messageBox" class="text-sm font-medium text-center text-red-600 h-5"></p>

                <button type="submit" id="submitBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-yellow-600 hover:bg-yellow-700 transition duration-150">
                    மதிப்பீட்டைச் சமர்ப்பிக்கவும்
                </button>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config (Please make sure this is your config!)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDD755-oGyx0hwrLykhF7m2k1uWFnLFMDQ",
            authDomain: "vorliyo.firebaseapp.com",
            projectId: "vorliyo",
            storageBucket: "vorliyo.firebasestorage.app",
            messagingSenderId: "480604417883",
            appId: "1:480604417883:web:5b4926a2a1b21f3ae2747e",
        };
        
        const firebaseConfig = FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'vorliyo-default-app-id';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let jobData = null; 
        let isRatingSubmitted = false;
        
        // Firestore Path Helpers
        const PUBLIC_JOBS_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'jobs');
        const RATINGS_COLLECTION = collection(db, 'artifacts', appId, 'public', 'data', 'ratings');
        
        const urlParams = new URLSearchParams(window.location.search);
        const jobId = urlParams.get('jobId'); // Expecting 'jobId' to identify the job/transaction

        // --- RATING STAR LOGIC ---
        const ratingScoreInput = document.getElementById('ratingScore');
        document.querySelectorAll('.rating-star').forEach(star => {
            star.addEventListener('click', function() {
                const score = parseInt(this.getAttribute('data-score'));
                ratingScoreInput.value = score;
                highlightStars(score);
            });
            star.addEventListener('mouseover', function() {
                const score = parseInt(this.getAttribute('data-score'));
                highlightStars(score);
            });
            star.addEventListener('mouseout', function() {
                highlightStars(parseInt(ratingScoreInput.value));
            });
        });

        function highlightStars(score) {
            document.querySelectorAll('.rating-star').forEach(star => {
                const starScore = parseInt(star.getAttribute('data-score'));
                if (starScore <= score) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // --- AUTH & DATA FETCH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if (jobId) {
                    fetchJobDetails(jobId);
                } else {
                    document.getElementById('jobDetails').textContent = "பிழை: வேலை ஐடி (Job ID) கிடைக்கவில்லை.";
                    document.getElementById('submitBtn').disabled = true;
                }
            } else {
                document.getElementById('jobDetails').textContent = "தயவுசெய்து உள்நுழையவும்.";
                setTimeout(() => { window.location.href = './user-login.html'; }, 2000);
            }
        });

        async function fetchJobDetails(id) {
            try {
                const jobDocRef = doc(PUBLIC_JOBS_COLLECTION, id);
                const docSnap = await getDoc(jobDocRef);
                
                if (docSnap.exists()) {
                    jobData = docSnap.data();
                    
                    // Check if the current user is either the client or the awarded freelancer
                    const isClient = currentUser.uid === jobData.clientId;
                    const isFreelancer = currentUser.uid === jobData.awardedFreelancerId;
                    
                    if (!isClient && !isFreelancer) {
                         document.getElementById('jobDetails').textContent = "இந்த வேலைக்கான மதிப்பீட்டைச் சமர்ப்பிக்க உங்களுக்கு அனுமதி இல்லை.";
                         document.getElementById('submitBtn').disabled = true;
                         return;
                    }

                    // Identify who the review is for (The recipient of the review)
                    const recipientId = isClient ? jobData.awardedFreelancerId : jobData.clientId;
                    const recipientName = isClient ? (jobData.awardedFreelancerName || 'Freelancer') : (jobData.clientName || 'Client');
                    const reviewerName = isClient ? (jobData.clientName || 'Client') : (jobData.awardedFreelancerName || 'Freelancer');
                    
                    // Display details
                    document.getElementById('jobDetails').innerHTML = `
                        <p class="font-semibold text-gray-800">வேலை: ${jobData.title}</p>
                        <p class="text-sm">நீங்கள் மதிப்பீடு செய்பவர்: **${recipientName}**</p>
                        <p class="text-xs text-gray-500">வேலை ID: ${id}</p>
                    `;
                    
                    // Check if review already exists (Highly simplified check)
                    // In a real app, you would query the RATINGS_COLLECTION for this jobId and the current user's UID.
                    if (jobData.ratingSubmittedBy && jobData.ratingSubmittedBy.includes(currentUser.uid)) {
                        document.getElementById('messageBox').textContent = "நீங்கள் ஏற்கனவே இந்த வேலைக்கு மதிப்பீடு செய்துள்ளீர்கள்.";
                        document.getElementById('messageBox').classList.add('text-green-600');
                        document.getElementById('submitBtn').disabled = true;
                        isRatingSubmitted = true;
                    }

                } else {
                    document.getElementById('jobDetails').textContent = "பிழை: வேலை விவரங்கள் காணப்படவில்லை.";
                    document.getElementById('submitBtn').disabled = true;
                }
            } catch (error) {
                console.error("Error fetching job details:", error);
                document.getElementById('jobDetails').textContent = "பிழை: வேலை விவரங்களைப் பெற முடியவில்லை.";
                document.getElementById('submitBtn').disabled = true;
            }
        }

        // --- FORM SUBMISSION ---
        document.getElementById('ratingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (isRatingSubmitted || !jobData || !currentUser) return;

            const score = parseInt(document.getElementById('ratingScore').value);
            const reviewText = document.getElementById('reviewText').value;
            const msgBox = document.getElementById('messageBox');

            if (score < 1 || score > 5) {
                msgBox.textContent = 'மதிப்பீட்டு நட்சத்திரங்களைத் தேர்ந்தெடுக்கவும்.';
                return;
            }
            
            msgBox.textContent = 'மதிப்பீட்டைச் சமர்ப்பிக்கிறது...';
            msgBox.classList.remove('text-green-600');
            msgBox.classList.add('text-red-600');
            document.getElementById('submitBtn').disabled = true;
            
            // Determine recipient and reviewer details again
            const isClient = currentUser.uid === jobData.clientId;
            const recipientId = isClient ? jobData.awardedFreelancerId : jobData.clientId;
            const recipientName = isClient ? (jobData.awardedFreelancerName || 'Freelancer') : (jobData.clientName || 'Client');
            const reviewerName = isClient ? (jobData.clientName || 'Client') : (jobData.awardedFreelancerName || 'Freelancer');


            const newRating = {
                jobId: jobId,
                reviewerId: currentUser.uid,
                reviewerName: reviewerName,
                recipientId: recipientId, 
                recipientName: recipientName,
                score: score,
                review: reviewText,
                createdAt: new Date(),
            };

            try {
                // 1. Add the rating document
                await addDoc(RATINGS_COLLECTION, newRating);
                
                // 2. Update the Job document to mark that this user has submitted a rating
                const jobDocRef = doc(PUBLIC_JOBS_COLLECTION, jobId);
                const existingRatings = jobData.ratingSubmittedBy || [];
                
                await updateDoc(jobDocRef, {
                    // This flag is highly simplified. A real app would track client and freelancer ratings separately.
                    ratingSubmittedBy: [...existingRatings, currentUser.uid],
                });

                msgBox.textContent = 'மதிப்பீடு வெற்றிகரமாகச் சமர்ப்பிக்கப்பட்டது! டாஷ்போர்டுக்குச் செல்கிறது...';
                msgBox.classList.remove('text-red-600');
                msgBox.classList.add('text-green-600');
                
                setTimeout(() => {
                    window.location.href = './user-dashboard.html';
                }, 1500);
                isRatingSubmitted = true;


            } catch (error) {
                console.error("Error submitting rating:", error);
                msgBox.textContent = 'மதிப்பீட்டைச் சமர்ப்பிப்பதில் பிழை ஏற்பட்டது.';
                document.getElementById('submitBtn').disabled = false;
            }
        });

        lucide.createIcons();
    </script>
</body>
</html>
```
